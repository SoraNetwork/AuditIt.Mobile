import{d as E,r as p,C as R,B as W,H as D,o as H,j as M,k as i,i as q,b,f as o,p as x,q as f,g as n,e as C,h as l,m as I,P as z,n as B,l as d}from"./index-B8gi7TZy.js";import{u as T}from"./itemStore-D1L0Git1.js";import{i as A}from"./browser-image-compression-BgY3rL5_.js";import{_ as G}from"./_plugin-vue_export-helper-DlAUqK2U.js";const J={class:"page-container"},K={key:0},Q={key:0},X=E({__name:"ItemEdit",setup(Y){const w=M(),_=q(),u=T(),r=p(null),a=R({remarks:""}),t=p([]),m=p(!1),v=p(!1),k=W(()=>r.value?.photoUrl?`${(D.defaults.baseURL||"").replace(/\/api$/,"")}${r.value.photoUrl}`:null);H(async()=>{const s=w.params.id;let e=u.items.find(c=>c.id===s);e||(await u.fetchItems({id:s}),e=u.items.find(c=>c.id===s)),e?(r.value=e,a.remarks=e.remarks||""):(i.error("未找到物品"),_.back())});const P=async s=>{if(t.value=s.fileList.slice(-1),t.value&&t.value.length>0&&t.value[0].originFileObj){v.value=!0,i.loading({content:"正在压缩图片...",key:"compressing"});try{const e=t.value[0].originFileObj,g=await A(e,{maxSizeMB:1,maxWidthOrHeight:1920,useWebWorker:!0});a.photo=g,m.value=!1,i.success({content:"图片压缩成功!",key:"compressing",duration:2})}catch(e){i.error({content:"图片压缩失败!",key:"compressing",duration:2}),console.error(e),a.photo=void 0,t.value=[]}finally{v.value=!1}}else a.photo=void 0},F=()=>{m.value=!0,t.value=[],a.photo=void 0,i.info("照片已标记为删除。保存后生效。")},S=async()=>{if(r.value)try{await u.updateItem(r.value.id,{remarks:a.remarks,photo:a.photo,deletePhoto:m.value}),i.success("物品信息已更新"),_.back()}catch{i.error("更新失败")}};return(s,e)=>{const c=n("a-page-header"),g=n("a-textarea"),h=n("a-form-item"),L=n("a-upload"),N=n("a-image"),U=n("a-button"),O=n("a-empty"),V=n("a-form"),$=n("a-card"),j=n("a-skeleton");return d(),b("div",null,[o(c,{title:`编辑: ${r.value?.shortId}`,onBack:e[0]||(e[0]=()=>f(_).back())},null,8,["title"]),x("div",J,[!f(u).loading&&r.value?(d(),C($,{key:0},{default:l(()=>[o(V,{model:a,onFinish:S,layout:"vertical"},{default:l(()=>[o(h,{label:"备注"},{default:l(()=>[o(g,{value:a.remarks,"onUpdate:value":e[1]||(e[1]=y=>a.remarks=y),rows:4},null,8,["value"])]),_:1}),o(h,{label:"更换照片"},{default:l(()=>[o(L,{"file-list":t.value,"onUpdate:fileList":e[2]||(e[2]=y=>t.value=y),"before-upload":()=>!1,onChange:P,"list-type":"picture-card","max-count":1,accept:"image/*"},{default:l(()=>[!t.value||t.value.length<1?(d(),b("div",K,[o(f(z)),e[3]||(e[3]=x("div",{style:{"margin-top":"8px"}},"上传",-1))])):I("",!0)]),_:1},8,["file-list"]),k.value&&!m.value?(d(),b("div",Q,[e[5]||(e[5]=x("p",null,"当前照片:",-1)),o(N,{width:100,src:k.value},null,8,["src"]),o(U,{type:"link",danger:"",onClick:F},{default:l(()=>e[4]||(e[4]=[B("删除照片",-1)])),_:1,__:[4]})])):I("",!0),!k.value&&!t.value?.length?(d(),C(O,{key:1,description:"暂无照片"})):I("",!0)]),_:1}),o(h,null,{default:l(()=>[o(U,{type:"primary",block:"","html-type":"submit",loading:f(u).loading||v.value},{default:l(()=>e[6]||(e[6]=[B(" 保存更改 ",-1)])),_:1,__:[6]},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})):(d(),C(j,{key:1,active:""}))])])}}}),ae=G(X,[["__scopeId","data-v-c9ec4a3f"]]);export{ae as default};
