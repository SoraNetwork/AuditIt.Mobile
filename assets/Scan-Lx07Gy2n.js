import{d as he,r as v,C as ye,B as be,w as J,o as Se,N as Ie,b as w,f as n,p as x,g as o,e as b,m as f,h as l,L as Ce,M as xe,q as z,k as _,n as c,F as X,E as Y,G as U,O as De,Q as $e,R as We,t as Q,S as Me,A as Z,l as u}from"./index-BwtKH47-.js";import{H as ee}from"./html5-qrcode-scanner-DL331H1d.js";import{u as Be}from"./itemStore-CcL7Hv6h.js";import{u as Le}from"./warehouseStore--WTCJf5X.js";import{_ as Ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ne={class:"page-container"},Oe={key:1},Ee={key:0,class:"controls"},Re={key:2},Fe={key:3,class:"feedback-container"},Te={key:4,class:"feedback-container"},ze={key:5,class:"item-details"},Ae={class:"action-buttons"},Ve=1500,qe=he({__name:"Scan",setup(Qe){const r=Be(),N=Le();let S=null;const g=v("scan"),O=v(""),h=v(!1),a=v(null),k=v(null),A=v(null),V=v(null),D=v(!1),$=v(null),W=v(0),E=v([]),d=v(null),R=v(!1),p=ye({targetWarehouseId:void 0,remarks:""}),te=be(()=>a.value?N.warehouses.filter(t=>t.id!==a.value?.warehouseId):N.warehouses),H=async()=>{if(A.value&&(S||(S=new ee(A.value.id,{verbose:!1})),E.value.length===0))try{const t=await ee.getCameras();if(t&&t.length){E.value=t;let e=t.find(i=>i.label.toLowerCase().includes("back"))||t.find(i=>i.label.toLowerCase().includes("后置"))||t.find(i=>i.label.toLowerCase().includes("rear"))||t[0];d.value=e.id}else k.value="未找到摄像头设备。"}catch{k.value="获取摄像头列表失败，请检查权限。"}},I=t=>{if(!S)return;B();const e={fps:30,qrbox:{width:200,height:200},frameRate:{ideal:15,max:30},autofocus:!0,colorDark:"#0000ff",colorLight:"#ffffff",visualFeedback:!0,halfSample:!0,experimentalFeatures:{useBarCodeDetectorIfSupported:!0}},i=async m=>{if(D.value){const C=Date.now();if($.value===m&&C-W.value<Ve)return;$.value=m,W.value=C,await ae(m)}else await M(),await F(m)};S.start(t,e,i,void 0).then(()=>{h.value=!0}).catch(m=>{k.value="无法启动摄像头。"})},M=async()=>{if(S&&h.value)try{await S.stop()}catch(t){console.error("Error stopping scanner:",t)}finally{h.value=!1}},ae=async t=>{try{if(await r.fetchItems({shortId:t}),r.items.length===0){_.error(`未找到ID为 "${t}" 的物品`);return}const e=r.items[0];if(e.status==="Disposed"){_.warning(`物品 ${t} 已处置，无法盘点`);return}await r.updateItemStatus(e.id,"check"),_.success({content:`✓ ${e.itemDefinition?.name||"物品"} (${t}) 盘点成功`,duration:2}),r.items=[]}catch{_.error(`盘点失败: ${t}`)}},ne=async()=>{h.value?await M():d.value?I(d.value):k.value="没有可用的摄像头。"},le=async t=>{await M(),d.value=t,I(t)},K=t=>{t&&F(t)},F=async t=>{await r.fetchItems({shortId:t}),r.items.length>0?a.value=r.items[0]:k.value=`未找到ID为 "${t}" 的物品。`},T=async t=>{if(!a.value)return;const e=async i=>{if(a.value)try{await r.updateItemStatus(a.value.id,t,i),_.success(`操作成功: ${t}`),t==="check"&&D.value?(B(),g.value==="scan"&&d.value?I(d.value):g.value==="manual"&&(await Z(),V.value?.focus())):await F(a.value.shortId)}catch{_.error("操作失败")}};if(t==="outbound"||t==="dispose"){let i;const m=t==="outbound"?"借出":"处置";We.confirm({title:`确认${m}`,content:Q("div",[Q("p","请输入目的地或原因："),Q(Me,{placeholder:"例如：借给张三，或处置原因",onChange:C=>{i=C.target.value}})]),onOk:()=>{if(!i)return _.error("目的地/原因不能为空"),Promise.reject();e(i)}})}else e()},se=()=>{a.value&&(p.targetWarehouseId=void 0,p.remarks="",R.value=!0)},oe=async()=>{if(!p.targetWarehouseId){_.error("请选择目标库房");return}if(a.value){if(p.targetWarehouseId===a.value.warehouseId){_.error("目标库房不能与当前库房相同");return}try{await r.transferWarehouse(a.value.id,p.targetWarehouseId,p.remarks||void 0);const t=N.warehouses.find(e=>e.id===p.targetWarehouseId);_.success(`成功转移到 ${t?.name||"目标库房"}`),R.value=!1,await F(a.value.shortId)}catch{_.error("转移失败，请重试")}}},B=()=>{a.value=null,k.value=null,O.value="",r.items=[],$.value=null,W.value=0};J(g,async t=>{$.value=null,W.value=0,t==="scan"?(await H(),d.value&&I(d.value)):(await M(),await Z(),V.value?.focus())}),J(D,t=>{$.value=null,W.value=0,t&&a.value&&(B(),g.value==="scan"&&d.value&&!h.value&&I(d.value))}),Se(async()=>{await N.fetchWarehouses(),await H(),g.value==="scan"&&d.value&&I(d.value)}),Ie(()=>{M()});const ue=t=>{switch(t){case"InStock":return"success";case"LoanedOut":return"warning";case"Disposed":return"error";case"SuspectedMissing":return"purple";default:return"default"}},re=t=>{switch(t){case"InStock":return"在库";case"LoanedOut":return"已借出";case"Disposed":return"已处置";case"SuspectedMissing":return"疑似丢失";default:return"未知"}};return(t,e)=>{const i=o("a-page-header"),m=o("a-radio-button"),C=o("a-radio-group"),ie=o("a-switch"),L=o("a-form-item"),j=o("a-select-option"),G=o("a-select"),y=o("a-button"),de=o("a-input-search"),P=o("a-form"),ce=o("a-spin"),ve=o("a-alert"),q=o("a-descriptions-item"),fe=o("a-badge"),pe=o("a-descriptions"),me=o("a-divider"),_e=o("a-card"),ge=o("a-input"),ke=o("a-textarea"),we=o("a-modal");return u(),w("div",null,[n(i,{title:"物品操作"}),x("div",Ne,[n(C,{value:g.value,"onUpdate:value":e[0]||(e[0]=s=>g.value=s),"button-style":"solid",style:{"margin-bottom":"16px",width:"100%"}},{default:l(()=>[n(m,{value:"scan",style:{width:"50%","text-align":"center"}},{default:l(()=>e[12]||(e[12]=[c("扫码输入",-1)])),_:1,__:[12]}),n(m,{value:"manual",style:{width:"50%","text-align":"center"}},{default:l(()=>e[13]||(e[13]=[c("手动输入",-1)])),_:1,__:[13]})]),_:1},8,["value"]),g.value==="scan"&&!a.value?(u(),b(L,{key:0,label:"连续盘点模式"},{default:l(()=>[n(ie,{checked:D.value,"onUpdate:checked":e[1]||(e[1]=s=>D.value=s)},null,8,["checked"]),e[14]||(e[14]=x("span",{style:{"margin-left":"8px",color:"#666","font-size":"12px"}}," 开启后将自动盘点扫描到的物品 ",-1))]),_:1,__:[14]})):f("",!0),g.value==="scan"?(u(),w("div",Oe,[Ce(x("div",null,[x("div",{id:"reader",ref_key:"readerRef",ref:A},null,512),E.value.length>1&&h.value?(u(),b(G,{key:0,value:d.value,"onUpdate:value":e[2]||(e[2]=s=>d.value=s),placeholder:"选择摄像头",style:{"margin-top":"8px",width:"100%"},onChange:le},{default:l(()=>[(u(!0),w(X,null,Y(E.value,s=>(u(),b(j,{key:s.id,value:s.id},{default:l(()=>[c(U(s.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])):f("",!0)],512),[[xe,!a.value&&!k.value]]),a.value?f("",!0):(u(),w("div",Ee,[n(y,{onClick:ne,danger:h.value,block:"",size:"large"},{default:l(()=>[c(U(h.value?"停止扫码":"开始扫码"),1)]),_:1},8,["danger"])]))])):f("",!0),g.value==="manual"&&!a.value?(u(),w("div",Re,[n(P,null,{default:l(()=>[n(L,{label:"通过物品ID查找"},{default:l(()=>[n(de,{ref_key:"manualInputRef",ref:V,value:O.value,"onUpdate:value":e[3]||(e[3]=s=>O.value=s),placeholder:"输入物品短ID","enter-button":"查找",onSearch:K,onKeydown:e[4]||(e[4]=De($e(s=>K(O.value),["prevent"]),["enter"]))},null,8,["value"])]),_:1})]),_:1})])):f("",!0),z(r).loading?(u(),w("div",Fe,[n(ce,{size:"large",tip:"正在获取物品信息..."})])):f("",!0),k.value&&!z(r).loading?(u(),w("div",Te,[n(ve,{message:"错误",description:k.value,type:"error","show-icon":""},{action:l(()=>[n(y,{size:"small",type:"primary",onClick:B},{default:l(()=>e[15]||(e[15]=[c("重试",-1)])),_:1,__:[15]})]),_:1},8,["description"])])):f("",!0),a.value&&!z(r).loading?(u(),w("div",ze,[n(_e,{title:a.value.itemDefinition?.name||"未知物品"},{default:l(()=>[n(pe,{bordered:"",column:1},{default:l(()=>[n(q,{label:"短ID"},{default:l(()=>[c(U(a.value.shortId),1)]),_:1}),n(q,{label:"状态"},{default:l(()=>[n(fe,{status:ue(a.value.status),text:re(a.value.status)},null,8,["status","text"])]),_:1}),n(q,{label:"仓库"},{default:l(()=>[c(U(a.value.warehouse?.name),1)]),_:1})]),_:1}),x("div",Ae,[e[22]||(e[22]=x("h3",null,"待操作列表",-1)),a.value.status==="InStock"?(u(),b(y,{key:0,onClick:e[5]||(e[5]=s=>T("outbound")),block:""},{default:l(()=>e[16]||(e[16]=[c("借出",-1)])),_:1,__:[16]})):f("",!0),a.value.status==="LoanedOut"||a.value.status==="SuspectedMissing"?(u(),b(y,{key:1,onClick:e[6]||(e[6]=s=>T("return")),block:""},{default:l(()=>e[17]||(e[17]=[c("归还",-1)])),_:1,__:[17]})):f("",!0),n(y,{onClick:e[7]||(e[7]=s=>T("check")),block:""},{default:l(()=>e[18]||(e[18]=[c("盘点",-1)])),_:1,__:[18]}),a.value.status!=="Disposed"?(u(),b(y,{key:2,onClick:se,block:""},{default:l(()=>e[19]||(e[19]=[c("转移库房",-1)])),_:1,__:[19]})):f("",!0),a.value.status!=="Disposed"?(u(),b(y,{key:3,onClick:e[8]||(e[8]=s=>T("dispose")),danger:"",block:""},{default:l(()=>e[20]||(e[20]=[c("处置",-1)])),_:1,__:[20]})):f("",!0),n(me),n(y,{onClick:B,block:""},{default:l(()=>e[21]||(e[21]=[c("查找下一个",-1)])),_:1,__:[21]})])]),_:1},8,["title"])])):f("",!0)]),n(we,{open:R.value,"onUpdate:open":e[11]||(e[11]=s=>R.value=s),title:"转移库房","ok-text":"确认转移","cancel-text":"取消","confirm-loading":z(r).loading,onOk:oe},{default:l(()=>[n(P,{layout:"vertical"},{default:l(()=>[n(L,{label:"当前库房"},{default:l(()=>[n(ge,{value:a.value?.warehouse?.name,disabled:""},null,8,["value"])]),_:1}),n(L,{label:"目标库房",required:""},{default:l(()=>[n(G,{value:p.targetWarehouseId,"onUpdate:value":e[9]||(e[9]=s=>p.targetWarehouseId=s),placeholder:"请选择目标库房",style:{width:"100%"}},{default:l(()=>[(u(!0),w(X,null,Y(te.value,s=>(u(),b(j,{key:s.id,value:s.id},{default:l(()=>[c(U(s.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),n(L,{label:"备注（可选）"},{default:l(()=>[n(ke,{value:p.remarks,"onUpdate:value":e[10]||(e[10]=s=>p.remarks=s),placeholder:"输入转移原因或备注",rows:3,maxlength:500,"show-count":""},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["open","confirm-loading"])])}}}),Je=Ue(qe,[["__scopeId","data-v-36b61d25"]]);export{Je as default};
