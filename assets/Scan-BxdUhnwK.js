import{d as oe,r as v,w as le,o as ue,N as re,b as k,f as a,p as C,g as o,e as b,m as d,h as n,L as ie,M as ce,q as E,n as c,F as de,E as ve,G as L,O as _e,Q as pe,R as fe,t as T,k as z,S as me,A as q,l as r}from"./index-B8gi7TZy.js";import{H as F}from"./html5-qrcode-scanner-Qt2slwys.js";import{u as ke}from"./itemStore-D1L0Git1.js";import{_ as ge}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ye={class:"page-container"},we={key:1},be={key:0,class:"controls"},he={key:2},Se={key:3,class:"feedback-container"},Ce={key:4,class:"feedback-container"},Ie={key:5,class:"item-details"},xe={class:"action-buttons"},De=oe({__name:"Scan",setup(Me){const p=ke();let w=null;const f=v("scan"),I=v(""),g=v(!1),s=v(null),_=v(null),$=v(null),B=v(null),N=v(!1),x=v([]),i=v(null),A=async()=>{if($.value&&(w||(w=new F($.value.id,{verbose:!1})),x.value.length===0))try{const t=await F.getCameras();if(t&&t.length){x.value=t;let e=t.find(u=>u.label.toLowerCase().includes("back"))||t.find(u=>u.label.toLowerCase().includes("后置"))||t.find(u=>u.label.toLowerCase().includes("rear"))||t[0];i.value=e.id}else _.value="未找到摄像头设备。"}catch{_.value="获取摄像头列表失败，请检查权限。"}},h=t=>{if(!w)return;M();const e={fps:10,qrbox:{width:250,height:250}},u=async m=>{await S(),await O(m)};w.start(t,e,u,void 0).then(()=>{g.value=!0}).catch(m=>{_.value="无法启动摄像头。"})},S=async()=>{if(w&&g.value)try{await w.stop()}catch(t){console.error("Error stopping scanner:",t)}finally{g.value=!1}},H=async()=>{g.value?await S():i.value?h(i.value):_.value="没有可用的摄像头。"},K=async t=>{await S(),i.value=t,h(t)},Q=t=>{t&&O(t)},O=async t=>{await p.fetchItems({shortId:t}),p.items.length>0?s.value=p.items[0]:_.value=`未找到ID为 "${t}" 的物品。`},D=async t=>{if(!s.value)return;const e=async u=>{if(s.value)try{await p.updateItemStatus(s.value.id,t,u),z.success(`操作成功: ${t}`),t==="check"&&N.value?(M(),f.value==="scan"&&i.value?h(i.value):f.value==="manual"&&(await q(),B.value?.focus())):await O(s.value.shortId)}catch{z.error("操作失败")}};if(t==="outbound"||t==="dispose"){let u;const m=t==="outbound"?"借出":"处置";fe.confirm({title:`确认${m}`,content:T("div",[T("p","请输入目的地或原因："),T(me,{placeholder:"例如：借给张三，或处置原因",onChange:R=>{u=R.target.value}})]),onOk:()=>{if(!u)return z.error("目的地/原因不能为空"),Promise.reject();e(u)}})}else e()},M=()=>{s.value=null,_.value=null,I.value="",p.items=[]};le(f,async t=>{t==="scan"?(await A(),i.value&&h(i.value)):(await S(),await q(),B.value?.focus())}),ue(async()=>{await A(),f.value==="scan"&&i.value&&h(i.value)}),re(()=>{S()});const j=t=>{switch(t){case"InStock":return"success";case"LoanedOut":return"warning";case"Disposed":return"error";case"SuspectedMissing":return"purple";default:return"default"}},G=t=>{switch(t){case"InStock":return"在库";case"LoanedOut":return"已借出";case"Disposed":return"已处置";case"SuspectedMissing":return"疑似丢失";default:return"未知"}};return(t,e)=>{const u=o("a-page-header"),m=o("a-radio-button"),R=o("a-radio-group"),P=o("a-switch"),V=o("a-form-item"),J=o("a-select-option"),W=o("a-select"),y=o("a-button"),X=o("a-input-search"),Y=o("a-form"),Z=o("a-spin"),ee=o("a-alert"),U=o("a-descriptions-item"),te=o("a-badge"),ae=o("a-descriptions"),ne=o("a-divider"),se=o("a-card");return r(),k("div",null,[a(u,{title:"物品操作"}),C("div",ye,[a(R,{value:f.value,"onUpdate:value":e[0]||(e[0]=l=>f.value=l),"button-style":"solid",style:{"margin-bottom":"16px",width:"100%"}},{default:n(()=>[a(m,{value:"scan",style:{width:"50%","text-align":"center"}},{default:n(()=>e[9]||(e[9]=[c("扫码输入",-1)])),_:1,__:[9]}),a(m,{value:"manual",style:{width:"50%","text-align":"center"}},{default:n(()=>e[10]||(e[10]=[c("手动输入",-1)])),_:1,__:[10]})]),_:1},8,["value"]),s.value?.status!=="Disposed"?(r(),b(V,{key:0,label:"连续盘点模式"},{default:n(()=>[a(P,{checked:N.value,"onUpdate:checked":e[1]||(e[1]=l=>N.value=l)},null,8,["checked"])]),_:1})):d("",!0),f.value==="scan"?(r(),k("div",we,[ie(C("div",null,[C("div",{id:"reader",ref_key:"readerRef",ref:$},null,512),x.value.length>1&&g.value?(r(),b(W,{key:0,value:i.value,"onUpdate:value":e[2]||(e[2]=l=>i.value=l),placeholder:"选择摄像头",style:{"margin-top":"8px",width:"100%"},onChange:K},{default:n(()=>[(r(!0),k(de,null,ve(x.value,l=>(r(),b(J,{key:l.id,value:l.id},{default:n(()=>[c(L(l.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])):d("",!0)],512),[[ce,!s.value&&!_.value]]),s.value?d("",!0):(r(),k("div",be,[a(y,{onClick:H,danger:g.value,block:"",size:"large"},{default:n(()=>[c(L(g.value?"停止扫描":"开始扫描"),1)]),_:1},8,["danger"])]))])):d("",!0),f.value==="manual"&&!s.value?(r(),k("div",he,[a(Y,null,{default:n(()=>[a(V,{label:"通过物品ID查找"},{default:n(()=>[a(X,{ref_key:"manualInputRef",ref:B,value:I.value,"onUpdate:value":e[3]||(e[3]=l=>I.value=l),placeholder:"输入物品短ID","enter-button":"查找",onSearch:Q,onKeydown:e[4]||(e[4]=_e(pe(l=>Q(I.value),["prevent"]),["enter"]))},null,8,["value"])]),_:1})]),_:1})])):d("",!0),E(p).loading?(r(),k("div",Se,[a(Z,{size:"large",tip:"正在获取物品信息..."})])):d("",!0),_.value&&!E(p).loading?(r(),k("div",Ce,[a(ee,{message:"错误",description:_.value,type:"error","show-icon":""},{action:n(()=>[a(y,{size:"small",type:"primary",onClick:M},{default:n(()=>e[11]||(e[11]=[c("重试",-1)])),_:1,__:[11]})]),_:1},8,["description"])])):d("",!0),s.value&&!E(p).loading?(r(),k("div",Ie,[a(se,{title:s.value.itemDefinition?.name||"未知物品"},{default:n(()=>[a(ae,{bordered:"",column:1},{default:n(()=>[a(U,{label:"短ID"},{default:n(()=>[c(L(s.value.shortId),1)]),_:1}),a(U,{label:"状态"},{default:n(()=>[a(te,{status:j(s.value.status),text:G(s.value.status)},null,8,["status","text"])]),_:1}),a(U,{label:"仓库"},{default:n(()=>[c(L(s.value.warehouse?.name),1)]),_:1})]),_:1}),C("div",xe,[e[17]||(e[17]=C("h3",null,"待操作列表",-1)),s.value.status==="InStock"?(r(),b(y,{key:0,onClick:e[5]||(e[5]=l=>D("outbound")),block:""},{default:n(()=>e[12]||(e[12]=[c("借出",-1)])),_:1,__:[12]})):d("",!0),s.value.status==="LoanedOut"||s.value.status==="SuspectedMissing"?(r(),b(y,{key:1,onClick:e[6]||(e[6]=l=>D("return")),block:""},{default:n(()=>e[13]||(e[13]=[c("归还",-1)])),_:1,__:[13]})):d("",!0),a(y,{onClick:e[7]||(e[7]=l=>D("check")),block:""},{default:n(()=>e[14]||(e[14]=[c("盘点",-1)])),_:1,__:[14]}),s.value.status!=="Disposed"?(r(),b(y,{key:2,onClick:e[8]||(e[8]=l=>D("dispose")),danger:"",block:""},{default:n(()=>e[15]||(e[15]=[c("处置",-1)])),_:1,__:[15]})):d("",!0),a(ne),a(y,{onClick:M,block:""},{default:n(()=>e[16]||(e[16]=[c("查找下一个",-1)])),_:1,__:[16]})])]),_:1},8,["title"])])):d("",!0)])])}}}),Oe=ge(De,[["__scopeId","data-v-33dd8c20"]]);export{Oe as default};
