import{d as _e,r as f,C as ge,B as ke,w as he,o as we,N as ye,b as _,f as n,p as D,g as l,e as w,m as c,h as o,L as be,M as Ie,q as O,n as i,F as G,E as P,G as M,O as Se,Q as Ce,R as xe,t as z,k as b,S as De,A as J,l as r}from"./index-nj7ITm60.js";import{H as X}from"./html5-qrcode-scanner-CAzFVmMU.js";import{u as Me}from"./itemStore-BWQkfLVM.js";import{u as We}from"./warehouseStore-gjyp0ekw.js";import{_ as Le}from"./_plugin-vue_export-helper-DlAUqK2U.js";const $e={class:"page-container"},Be={key:1},Ue={key:0,class:"controls"},Re={key:2},Te={key:3,class:"feedback-container"},Oe={key:4,class:"feedback-container"},Fe={key:5,class:"item-details"},Ne={class:"action-buttons"},Ee=_e({__name:"Scan",setup(Ve){const p=Me(),W=We();let I=null;const g=f("scan"),L=f(""),y=f(!1),a=f(null),m=f(null),F=f(null),N=f(null),E=f(!1),$=f([]),d=f(null),B=f(!1),v=ge({targetWarehouseId:void 0,remarks:""}),Y=ke(()=>a.value?W.warehouses.filter(t=>t.id!==a.value?.warehouseId):W.warehouses),A=async()=>{if(F.value&&(I||(I=new X(F.value.id,{verbose:!1})),$.value.length===0))try{const t=await X.getCameras();if(t&&t.length){$.value=t;let e=t.find(u=>u.label.toLowerCase().includes("back"))||t.find(u=>u.label.toLowerCase().includes("后置"))||t.find(u=>u.label.toLowerCase().includes("rear"))||t[0];d.value=e.id}else m.value="未找到摄像头设备。"}catch{m.value="获取摄像头列表失败，请检查权限。"}},S=t=>{if(!I)return;T();const e={fps:10,qrbox:{width:250,height:250},frameRate:{ideal:15,max:30},autofocus:!0,colorDark:"#0000ff",colorLight:"#ffffff",visualFeedback:!0,halfSample:!1,experimentalFeatures:{useBarCodeDetectorIfSupported:!0},videoConstraints:{width:{ideal:1920,min:640},height:{ideal:1080,min:480},aspectRatio:{ideal:1.7777777778},focusMode:"continuous",exposureMode:"continuous",facingMode:{exact:"environment"}}},u=async k=>{await C(),await U(k)};I.start(t,e,u,void 0).then(()=>{y.value=!0}).catch(k=>{m.value="无法启动摄像头。"})},C=async()=>{if(I&&y.value)try{await I.stop()}catch(t){console.error("Error stopping scanner:",t)}finally{y.value=!1}},Z=async()=>{y.value?await C():d.value?S(d.value):m.value="没有可用的摄像头。"},ee=async t=>{await C(),d.value=t,S(t)},Q=t=>{t&&U(t)},U=async t=>{await p.fetchItems({shortId:t}),p.items.length>0?a.value=p.items[0]:m.value=`未找到ID为 "${t}" 的物品。`},R=async t=>{if(!a.value)return;const e=async u=>{if(a.value)try{await p.updateItemStatus(a.value.id,t,u),b.success(`操作成功: ${t}`),t==="check"&&E.value?(T(),g.value==="scan"&&d.value?S(d.value):g.value==="manual"&&(await J(),N.value?.focus())):await U(a.value.shortId)}catch{b.error("操作失败")}};if(t==="outbound"||t==="dispose"){let u;const k=t==="outbound"?"借出":"处置";xe.confirm({title:`确认${k}`,content:z("div",[z("p","请输入目的地或原因："),z(De,{placeholder:"例如：借给张三，或处置原因",onChange:V=>{u=V.target.value}})]),onOk:()=>{if(!u)return b.error("目的地/原因不能为空"),Promise.reject();e(u)}})}else e()},te=()=>{a.value&&(v.targetWarehouseId=void 0,v.remarks="",B.value=!0)},ae=async()=>{if(!v.targetWarehouseId){b.error("请选择目标库房");return}if(a.value){if(v.targetWarehouseId===a.value.warehouseId){b.error("目标库房不能与当前库房相同");return}try{await p.transferWarehouse(a.value.id,v.targetWarehouseId,v.remarks||void 0);const t=W.warehouses.find(e=>e.id===v.targetWarehouseId);b.success(`成功转移到 ${t?.name||"目标库房"}`),B.value=!1,await U(a.value.shortId)}catch{b.error("转移失败，请重试")}}},T=()=>{a.value=null,m.value=null,L.value="",p.items=[]};he(g,async t=>{t==="scan"?(await A(),d.value&&S(d.value)):(await C(),await J(),N.value?.focus())}),we(async()=>{await W.fetchWarehouses(),await A(),g.value==="scan"&&d.value&&S(d.value)}),ye(()=>{C()});const ne=t=>{switch(t){case"InStock":return"success";case"LoanedOut":return"warning";case"Disposed":return"error";case"SuspectedMissing":return"purple";default:return"default"}},oe=t=>{switch(t){case"InStock":return"在库";case"LoanedOut":return"已借出";case"Disposed":return"已处置";case"SuspectedMissing":return"疑似丢失";default:return"未知"}};return(t,e)=>{const u=l("a-page-header"),k=l("a-radio-button"),V=l("a-radio-group"),se=l("a-switch"),x=l("a-form-item"),H=l("a-select-option"),K=l("a-select"),h=l("a-button"),le=l("a-input-search"),j=l("a-form"),re=l("a-spin"),ue=l("a-alert"),q=l("a-descriptions-item"),ie=l("a-badge"),de=l("a-descriptions"),ce=l("a-divider"),ve=l("a-card"),fe=l("a-input"),pe=l("a-textarea"),me=l("a-modal");return r(),_("div",null,[n(u,{title:"物品操作"}),D("div",$e,[n(V,{value:g.value,"onUpdate:value":e[0]||(e[0]=s=>g.value=s),"button-style":"solid",style:{"margin-bottom":"16px",width:"100%"}},{default:o(()=>[n(k,{value:"scan",style:{width:"50%","text-align":"center"}},{default:o(()=>e[12]||(e[12]=[i("扫码输入",-1)])),_:1,__:[12]}),n(k,{value:"manual",style:{width:"50%","text-align":"center"}},{default:o(()=>e[13]||(e[13]=[i("手动输入",-1)])),_:1,__:[13]})]),_:1},8,["value"]),a.value?.status!=="Disposed"?(r(),w(x,{key:0,label:"连续盘点模式"},{default:o(()=>[n(se,{checked:E.value,"onUpdate:checked":e[1]||(e[1]=s=>E.value=s)},null,8,["checked"])]),_:1})):c("",!0),g.value==="scan"?(r(),_("div",Be,[be(D("div",null,[D("div",{id:"reader",ref_key:"readerRef",ref:F},null,512),$.value.length>1&&y.value?(r(),w(K,{key:0,value:d.value,"onUpdate:value":e[2]||(e[2]=s=>d.value=s),placeholder:"选择摄像头",style:{"margin-top":"8px",width:"100%"},onChange:ee},{default:o(()=>[(r(!0),_(G,null,P($.value,s=>(r(),w(H,{key:s.id,value:s.id},{default:o(()=>[i(M(s.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])):c("",!0)],512),[[Ie,!a.value&&!m.value]]),a.value?c("",!0):(r(),_("div",Ue,[n(h,{onClick:Z,danger:y.value,block:"",size:"large"},{default:o(()=>[i(M(y.value?"停止扫码":"开始扫码"),1)]),_:1},8,["danger"])]))])):c("",!0),g.value==="manual"&&!a.value?(r(),_("div",Re,[n(j,null,{default:o(()=>[n(x,{label:"通过物品ID查找"},{default:o(()=>[n(le,{ref_key:"manualInputRef",ref:N,value:L.value,"onUpdate:value":e[3]||(e[3]=s=>L.value=s),placeholder:"输入物品短ID","enter-button":"查找",onSearch:Q,onKeydown:e[4]||(e[4]=Se(Ce(s=>Q(L.value),["prevent"]),["enter"]))},null,8,["value"])]),_:1})]),_:1})])):c("",!0),O(p).loading?(r(),_("div",Te,[n(re,{size:"large",tip:"正在获取物品信息..."})])):c("",!0),m.value&&!O(p).loading?(r(),_("div",Oe,[n(ue,{message:"错误",description:m.value,type:"error","show-icon":""},{action:o(()=>[n(h,{size:"small",type:"primary",onClick:T},{default:o(()=>e[14]||(e[14]=[i("重试",-1)])),_:1,__:[14]})]),_:1},8,["description"])])):c("",!0),a.value&&!O(p).loading?(r(),_("div",Fe,[n(ve,{title:a.value.itemDefinition?.name||"未知物品"},{default:o(()=>[n(de,{bordered:"",column:1},{default:o(()=>[n(q,{label:"短ID"},{default:o(()=>[i(M(a.value.shortId),1)]),_:1}),n(q,{label:"状态"},{default:o(()=>[n(ie,{status:ne(a.value.status),text:oe(a.value.status)},null,8,["status","text"])]),_:1}),n(q,{label:"仓库"},{default:o(()=>[i(M(a.value.warehouse?.name),1)]),_:1})]),_:1}),D("div",Ne,[e[21]||(e[21]=D("h3",null,"待操作列表",-1)),a.value.status==="InStock"?(r(),w(h,{key:0,onClick:e[5]||(e[5]=s=>R("outbound")),block:""},{default:o(()=>e[15]||(e[15]=[i("借出",-1)])),_:1,__:[15]})):c("",!0),a.value.status==="LoanedOut"||a.value.status==="SuspectedMissing"?(r(),w(h,{key:1,onClick:e[6]||(e[6]=s=>R("return")),block:""},{default:o(()=>e[16]||(e[16]=[i("归还",-1)])),_:1,__:[16]})):c("",!0),n(h,{onClick:e[7]||(e[7]=s=>R("check")),block:""},{default:o(()=>e[17]||(e[17]=[i("盘点",-1)])),_:1,__:[17]}),a.value.status!=="Disposed"?(r(),w(h,{key:2,onClick:te,block:""},{default:o(()=>e[18]||(e[18]=[i("转移库房",-1)])),_:1,__:[18]})):c("",!0),a.value.status!=="Disposed"?(r(),w(h,{key:3,onClick:e[8]||(e[8]=s=>R("dispose")),danger:"",block:""},{default:o(()=>e[19]||(e[19]=[i("处置",-1)])),_:1,__:[19]})):c("",!0),n(ce),n(h,{onClick:T,block:""},{default:o(()=>e[20]||(e[20]=[i("查找下一个",-1)])),_:1,__:[20]})])]),_:1},8,["title"])])):c("",!0)]),n(me,{open:B.value,"onUpdate:open":e[11]||(e[11]=s=>B.value=s),title:"转移库房","ok-text":"确认转移","cancel-text":"取消","confirm-loading":O(p).loading,onOk:ae},{default:o(()=>[n(j,{layout:"vertical"},{default:o(()=>[n(x,{label:"当前库房"},{default:o(()=>[n(fe,{value:a.value?.warehouse?.name,disabled:""},null,8,["value"])]),_:1}),n(x,{label:"目标库房",required:""},{default:o(()=>[n(K,{value:v.targetWarehouseId,"onUpdate:value":e[9]||(e[9]=s=>v.targetWarehouseId=s),placeholder:"请选择目标库房",style:{width:"100%"}},{default:o(()=>[(r(!0),_(G,null,P(Y.value,s=>(r(),w(H,{key:s.id,value:s.id},{default:o(()=>[i(M(s.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),n(x,{label:"备注（可选）"},{default:o(()=>[n(pe,{value:v.remarks,"onUpdate:value":e[10]||(e[10]=s=>v.remarks=s),placeholder:"输入转移原因或备注",rows:3,maxlength:500,"show-count":""},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["open","confirm-loading"])])}}}),Ke=Le(Ee,[["__scopeId","data-v-bcd82424"]]);export{Ke as default};
