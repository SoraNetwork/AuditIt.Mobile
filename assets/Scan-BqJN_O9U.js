import{d as ke,r as p,C as we,B as he,w as G,o as ye,N as be,b as w,f as n,p as C,g as l,e as b,m as v,h as o,L as Se,M as Ie,q as F,k as m,n as c,F as P,E as J,G as M,O as Ce,Q as xe,R as De,t as q,S as $e,A as X,l as r}from"./index-Dpe5WKH1.js";import{H as Y}from"./html5-qrcode-scanner-8C_WyYV3.js";import{u as We}from"./itemStore-C7LspQwq.js";import{u as Me}from"./warehouseStore-BhHZVhUd.js";import{_ as Le}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Be={class:"page-container"},Ue={key:1},Oe={key:0,class:"controls"},Re={key:2},Te={key:3,class:"feedback-container"},Fe={key:4,class:"feedback-container"},Ne={key:5,class:"item-details"},ze={class:"action-buttons"},Ee=ke({__name:"Scan",setup(Ve){const u=We(),L=Me();let S=null;const _=p("scan"),B=p(""),h=p(!1),a=p(null),g=p(null),N=p(null),z=p(null),x=p(!1),U=p([]),d=p(null),O=p(!1),f=we({targetWarehouseId:void 0,remarks:""}),Z=he(()=>a.value?L.warehouses.filter(t=>t.id!==a.value?.warehouseId):L.warehouses),A=async()=>{if(N.value&&(S||(S=new Y(N.value.id,{verbose:!1})),U.value.length===0))try{const t=await Y.getCameras();if(t&&t.length){U.value=t;let e=t.find(i=>i.label.toLowerCase().includes("back"))||t.find(i=>i.label.toLowerCase().includes("后置"))||t.find(i=>i.label.toLowerCase().includes("rear"))||t[0];d.value=e.id}else g.value="未找到摄像头设备。"}catch{g.value="获取摄像头列表失败，请检查权限。"}},I=t=>{if(!S)return;$();const e={fps:30,qrbox:{width:200,height:200},frameRate:{ideal:15,max:30},autofocus:!0,colorDark:"#0000ff",colorLight:"#ffffff",visualFeedback:!0,halfSample:!0,experimentalFeatures:{useBarCodeDetectorIfSupported:!0}},i=async k=>{x.value?await ee(k):(await D(),await R(k))};S.start(t,e,i,void 0).then(()=>{h.value=!0}).catch(k=>{g.value="无法启动摄像头。"})},D=async()=>{if(S&&h.value)try{await S.stop()}catch(t){console.error("Error stopping scanner:",t)}finally{h.value=!1}},ee=async t=>{try{if(await u.fetchItems({shortId:t}),u.items.length===0){m.error(`未找到ID为 "${t}" 的物品`);return}const e=u.items[0];if(e.status==="Disposed"){m.warning(`物品 ${t} 已处置，无法盘点`);return}await u.updateItemStatus(e.id,"check"),m.success({content:`✓ ${e.itemDefinition?.name||"物品"} (${t}) 盘点成功`,duration:2}),u.items=[]}catch{m.error(`盘点失败: ${t}`)}},te=async()=>{h.value?await D():d.value?I(d.value):g.value="没有可用的摄像头。"},ae=async t=>{await D(),d.value=t,I(t)},Q=t=>{t&&R(t)},R=async t=>{await u.fetchItems({shortId:t}),u.items.length>0?a.value=u.items[0]:g.value=`未找到ID为 "${t}" 的物品。`},T=async t=>{if(!a.value)return;const e=async i=>{if(a.value)try{await u.updateItemStatus(a.value.id,t,i),m.success(`操作成功: ${t}`),t==="check"&&x.value?($(),_.value==="scan"&&d.value?I(d.value):_.value==="manual"&&(await X(),z.value?.focus())):await R(a.value.shortId)}catch{m.error("操作失败")}};if(t==="outbound"||t==="dispose"){let i;const k=t==="outbound"?"借出":"处置";De.confirm({title:`确认${k}`,content:q("div",[q("p","请输入目的地或原因："),q($e,{placeholder:"例如：借给张三，或处置原因",onChange:E=>{i=E.target.value}})]),onOk:()=>{if(!i)return m.error("目的地/原因不能为空"),Promise.reject();e(i)}})}else e()},ne=()=>{a.value&&(f.targetWarehouseId=void 0,f.remarks="",O.value=!0)},oe=async()=>{if(!f.targetWarehouseId){m.error("请选择目标库房");return}if(a.value){if(f.targetWarehouseId===a.value.warehouseId){m.error("目标库房不能与当前库房相同");return}try{await u.transferWarehouse(a.value.id,f.targetWarehouseId,f.remarks||void 0);const t=L.warehouses.find(e=>e.id===f.targetWarehouseId);m.success(`成功转移到 ${t?.name||"目标库房"}`),O.value=!1,await R(a.value.shortId)}catch{m.error("转移失败，请重试")}}},$=()=>{a.value=null,g.value=null,B.value="",u.items=[]};G(_,async t=>{t==="scan"?(await A(),d.value&&I(d.value)):(await D(),await X(),z.value?.focus())}),G(x,t=>{t&&a.value&&($(),_.value==="scan"&&d.value&&!h.value&&I(d.value))}),ye(async()=>{await L.fetchWarehouses(),await A(),_.value==="scan"&&d.value&&I(d.value)}),be(()=>{D()});const se=t=>{switch(t){case"InStock":return"success";case"LoanedOut":return"warning";case"Disposed":return"error";case"SuspectedMissing":return"purple";default:return"default"}},le=t=>{switch(t){case"InStock":return"在库";case"LoanedOut":return"已借出";case"Disposed":return"已处置";case"SuspectedMissing":return"疑似丢失";default:return"未知"}};return(t,e)=>{const i=l("a-page-header"),k=l("a-radio-button"),E=l("a-radio-group"),re=l("a-switch"),W=l("a-form-item"),H=l("a-select-option"),K=l("a-select"),y=l("a-button"),ue=l("a-input-search"),j=l("a-form"),ie=l("a-spin"),de=l("a-alert"),V=l("a-descriptions-item"),ce=l("a-badge"),ve=l("a-descriptions"),fe=l("a-divider"),pe=l("a-card"),me=l("a-input"),_e=l("a-textarea"),ge=l("a-modal");return r(),w("div",null,[n(i,{title:"物品操作"}),C("div",Be,[n(E,{value:_.value,"onUpdate:value":e[0]||(e[0]=s=>_.value=s),"button-style":"solid",style:{"margin-bottom":"16px",width:"100%"}},{default:o(()=>[n(k,{value:"scan",style:{width:"50%","text-align":"center"}},{default:o(()=>e[12]||(e[12]=[c("扫码输入",-1)])),_:1,__:[12]}),n(k,{value:"manual",style:{width:"50%","text-align":"center"}},{default:o(()=>e[13]||(e[13]=[c("手动输入",-1)])),_:1,__:[13]})]),_:1},8,["value"]),_.value==="scan"&&!a.value?(r(),b(W,{key:0,label:"连续盘点模式"},{default:o(()=>[n(re,{checked:x.value,"onUpdate:checked":e[1]||(e[1]=s=>x.value=s)},null,8,["checked"]),e[14]||(e[14]=C("span",{style:{"margin-left":"8px",color:"#666","font-size":"12px"}}," 开启后将自动盘点扫描到的物品 ",-1))]),_:1,__:[14]})):v("",!0),_.value==="scan"?(r(),w("div",Ue,[Se(C("div",null,[C("div",{id:"reader",ref_key:"readerRef",ref:N},null,512),U.value.length>1&&h.value?(r(),b(K,{key:0,value:d.value,"onUpdate:value":e[2]||(e[2]=s=>d.value=s),placeholder:"选择摄像头",style:{"margin-top":"8px",width:"100%"},onChange:ae},{default:o(()=>[(r(!0),w(P,null,J(U.value,s=>(r(),b(H,{key:s.id,value:s.id},{default:o(()=>[c(M(s.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])):v("",!0)],512),[[Ie,!a.value&&!g.value]]),a.value?v("",!0):(r(),w("div",Oe,[n(y,{onClick:te,danger:h.value,block:"",size:"large"},{default:o(()=>[c(M(h.value?"停止扫码":"开始扫码"),1)]),_:1},8,["danger"])]))])):v("",!0),_.value==="manual"&&!a.value?(r(),w("div",Re,[n(j,null,{default:o(()=>[n(W,{label:"通过物品ID查找"},{default:o(()=>[n(ue,{ref_key:"manualInputRef",ref:z,value:B.value,"onUpdate:value":e[3]||(e[3]=s=>B.value=s),placeholder:"输入物品短ID","enter-button":"查找",onSearch:Q,onKeydown:e[4]||(e[4]=Ce(xe(s=>Q(B.value),["prevent"]),["enter"]))},null,8,["value"])]),_:1})]),_:1})])):v("",!0),F(u).loading?(r(),w("div",Te,[n(ie,{size:"large",tip:"正在获取物品信息..."})])):v("",!0),g.value&&!F(u).loading?(r(),w("div",Fe,[n(de,{message:"错误",description:g.value,type:"error","show-icon":""},{action:o(()=>[n(y,{size:"small",type:"primary",onClick:$},{default:o(()=>e[15]||(e[15]=[c("重试",-1)])),_:1,__:[15]})]),_:1},8,["description"])])):v("",!0),a.value&&!F(u).loading?(r(),w("div",Ne,[n(pe,{title:a.value.itemDefinition?.name||"未知物品"},{default:o(()=>[n(ve,{bordered:"",column:1},{default:o(()=>[n(V,{label:"短ID"},{default:o(()=>[c(M(a.value.shortId),1)]),_:1}),n(V,{label:"状态"},{default:o(()=>[n(ce,{status:se(a.value.status),text:le(a.value.status)},null,8,["status","text"])]),_:1}),n(V,{label:"仓库"},{default:o(()=>[c(M(a.value.warehouse?.name),1)]),_:1})]),_:1}),C("div",ze,[e[22]||(e[22]=C("h3",null,"待操作列表",-1)),a.value.status==="InStock"?(r(),b(y,{key:0,onClick:e[5]||(e[5]=s=>T("outbound")),block:""},{default:o(()=>e[16]||(e[16]=[c("借出",-1)])),_:1,__:[16]})):v("",!0),a.value.status==="LoanedOut"||a.value.status==="SuspectedMissing"?(r(),b(y,{key:1,onClick:e[6]||(e[6]=s=>T("return")),block:""},{default:o(()=>e[17]||(e[17]=[c("归还",-1)])),_:1,__:[17]})):v("",!0),n(y,{onClick:e[7]||(e[7]=s=>T("check")),block:""},{default:o(()=>e[18]||(e[18]=[c("盘点",-1)])),_:1,__:[18]}),a.value.status!=="Disposed"?(r(),b(y,{key:2,onClick:ne,block:""},{default:o(()=>e[19]||(e[19]=[c("转移库房",-1)])),_:1,__:[19]})):v("",!0),a.value.status!=="Disposed"?(r(),b(y,{key:3,onClick:e[8]||(e[8]=s=>T("dispose")),danger:"",block:""},{default:o(()=>e[20]||(e[20]=[c("处置",-1)])),_:1,__:[20]})):v("",!0),n(fe),n(y,{onClick:$,block:""},{default:o(()=>e[21]||(e[21]=[c("查找下一个",-1)])),_:1,__:[21]})])]),_:1},8,["title"])])):v("",!0)]),n(ge,{open:O.value,"onUpdate:open":e[11]||(e[11]=s=>O.value=s),title:"转移库房","ok-text":"确认转移","cancel-text":"取消","confirm-loading":F(u).loading,onOk:oe},{default:o(()=>[n(j,{layout:"vertical"},{default:o(()=>[n(W,{label:"当前库房"},{default:o(()=>[n(me,{value:a.value?.warehouse?.name,disabled:""},null,8,["value"])]),_:1}),n(W,{label:"目标库房",required:""},{default:o(()=>[n(K,{value:f.targetWarehouseId,"onUpdate:value":e[9]||(e[9]=s=>f.targetWarehouseId=s),placeholder:"请选择目标库房",style:{width:"100%"}},{default:o(()=>[(r(!0),w(P,null,J(Z.value,s=>(r(),b(H,{key:s.id,value:s.id},{default:o(()=>[c(M(s.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),n(W,{label:"备注（可选）"},{default:o(()=>[n(_e,{value:f.remarks,"onUpdate:value":e[10]||(e[10]=s=>f.remarks=s),placeholder:"输入转移原因或备注",rows:3,maxlength:500,"show-count":""},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["open","confirm-loading"])])}}}),je=Le(Ee,[["__scopeId","data-v-51bda4e7"]]);export{je as default};
