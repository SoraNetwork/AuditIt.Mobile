import{u as E}from"./warehouseStore-CwETBunU.js";import{u as F}from"./itemStore-ohO8iqmP.js";import{u as T}from"./auditLogStore-DnL0AFM4.js";import{d as q,C as z,W as L,r as u,o as G,w as $,b as M,f as e,p as y,g as s,h as a,F as H,E as J,q as K,n as i,G as _,k as m,l as b,e as P}from"./index-CnWZh0I3.js";import{_ as Q}from"./_plugin-vue_export-helper-DlAUqK2U.js";const X={class:"page-container"},Y={class:"scrollable-list"},Z={class:"scrollable-list"},ee=q({__name:"CheckAnalysis",setup(ae){const S=E(),h=F(),C=T(),l=z({warehouseId:void 0,dateRange:[L().subtract(1,"day"),L()]}),c=u(!1),g=u(!1),p=u([]),f=u([]),d=u({});G(()=>{S.fetchWarehouses()}),$(()=>l.warehouseId,()=>{p.value=[],f.value=[],d.value={}});const D=async()=>{if(!l.warehouseId){m.error("请先选择一个仓库");return}c.value=!0,p.value=[],f.value=[],d.value={};try{await h.fetchItems({warehouseId:l.warehouseId,status:"InStock"});const r=h.items;await C.fetchLogs();const t=l.dateRange[0].startOf("day").toDate(),k=l.dateRange[1].endOf("day").toDate(),v=new Set(C.logs.filter(n=>n.action==="Check"&&n.warehouseId===l.warehouseId&&new Date(n.timestamp)>=t&&new Date(n.timestamp)<=k).map(n=>n.itemId));p.value=r.filter(n=>v.has(n.id)),f.value=r.filter(n=>!v.has(n.id))}catch(r){m.error("分析失败: "+(r.message||r))}finally{c.value=!1}},O=async()=>{const r=Object.entries(d.value).filter(([,t])=>t).map(([t])=>t);if(r.length===0){m.warn("请至少选择一个物品");return}g.value=!0;try{await h.updateStatusBatch(r,"SuspectedMissing"),m.success("成功标记为疑似丢失"),await D()}catch(t){m.error("标记失败: "+(t.message||t))}finally{g.value=!1}};return(r,t)=>{const k=s("a-page-header"),v=s("a-select-option"),n=s("a-select"),I=s("a-form-item"),U=s("a-range-picker"),x=s("a-button"),j=s("a-form"),w=s("a-card"),N=s("a-checkbox"),B=s("a-list-item"),R=s("a-list"),A=s("a-col"),V=s("a-row");return b(),M("div",null,[e(k,{title:"盘点分析","sub-title":"查看盘点差异并处理",onBack:t[0]||(t[0]=()=>r.$router.back())}),y("div",X,[e(w,null,{default:a(()=>[e(j,{model:l,layout:"vertical"},{default:a(()=>[e(I,{label:"选择仓库"},{default:a(()=>[e(n,{value:l.warehouseId,"onUpdate:value":t[1]||(t[1]=o=>l.warehouseId=o),placeholder:"请选择仓库","allow-clear":""},{default:a(()=>[(b(!0),M(H,null,J(K(S).warehouses,o=>(b(),P(v,{key:o.id,value:o.id},{default:a(()=>[i(_(o.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),e(I,{label:"盘点日期范围"},{default:a(()=>[e(U,{value:l.dateRange,"onUpdate:value":t[2]||(t[2]=o=>l.dateRange=o),style:{width:"100%"}},null,8,["value"])]),_:1}),e(I,null,{default:a(()=>[e(x,{type:"primary",onClick:D,loading:c.value,block:""},{default:a(()=>t[3]||(t[3]=[i("开始分析",-1)])),_:1,__:[3]},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),e(V,{gutter:[16,16],style:{"margin-top":"16px"}},{default:a(()=>[e(A,{span:24},{default:a(()=>[e(w,{title:"未盘点物品 (疑似丢失)"},{extra:a(()=>[e(x,{type:"primary",danger:"",size:"small",disabled:Object.values(d.value).every(o=>!o),onClick:O,loading:g.value},{default:a(()=>t[4]||(t[4]=[i(" 标记为丢失 ",-1)])),_:1,__:[4]},8,["disabled","loading"])]),default:a(()=>[y("div",Y,[e(R,{"data-source":f.value,loading:c.value,bordered:!0},{renderItem:a(({item:o})=>[e(B,null,{default:a(()=>[e(N,{value:o.id,checked:d.value[o.id],"onUpdate:checked":W=>d.value[o.id]=W},{default:a(()=>[i(_(o.itemDefinition?.name)+" ("+_(o.shortId)+") ",1)]),_:2},1032,["value","checked","onUpdate:checked"])]),_:2},1024)]),_:1},8,["data-source","loading"])])]),_:1})]),_:1}),e(A,{span:24},{default:a(()=>[e(w,{title:"已盘点物品"},{default:a(()=>[y("div",Z,[e(R,{"data-source":p.value,loading:c.value,bordered:!0},{renderItem:a(({item:o})=>[e(B,null,{default:a(()=>[i(_(o.itemDefinition?.name)+" ("+_(o.shortId)+")",1)]),_:2},1024)]),_:1},8,["data-source","loading"])])]),_:1})]),_:1})]),_:1})])])}}}),re=Q(ee,[["__scopeId","data-v-3c555ede"]]);export{re as default};
