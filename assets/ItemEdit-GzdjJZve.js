import{d as E,r as v,C as R,B as W,H,o as M,j as q,k as i,i as z,b,f as o,p as x,q as f,g as n,e as C,h as s,m as D,P as T,n as U,l as d}from"./index-CrOvgli2.js";import{u as A}from"./itemStore-CQyb4Wl6.js";import{i as G}from"./browser-image-compression-BgY3rL5_.js";import{_ as J}from"./_plugin-vue_export-helper-DlAUqK2U.js";const K={class:"page-container"},Q={key:0},X={key:0},Y=E({__name:"ItemEdit",setup(Z){const B=q(),k=z(),u=A(),r=v(null),t=R({remarks:"",currentDestination:"",photo:void 0}),a=v([]),p=v(!1),g=v(!1),y=W(()=>r.value?.photoUrl?`${(H.defaults.baseURL||"").replace(/\/api$/,"")}${r.value.photoUrl}`:null);M(async()=>{const l=B.params.id;let e=u.items.find(c=>c.id===l);e||(await u.fetchItems({id:l}),e=u.items.find(c=>c.id===l)),e?(r.value=e,t.remarks=e.remarks||"",t.currentDestination=e.currentDestination||""):(i.error("未找到物品"),k.back())});const w=async l=>{if(a.value=l.fileList.slice(-1),a.value&&a.value.length>0&&a.value[0].originFileObj){g.value=!0,i.loading({content:"正在压缩图片...",key:"compressing"});try{const e=a.value[0].originFileObj,h=await G(e,{maxSizeMB:1,maxWidthOrHeight:1920,useWebWorker:!0});t.photo=h,p.value=!1,i.success({content:"图片压缩成功!",key:"compressing",duration:2})}catch(e){i.error({content:"图片压缩失败!",key:"compressing",duration:2}),console.error(e),t.photo=void 0,a.value=[]}finally{g.value=!1}}else t.photo=void 0},P=()=>{p.value=!0,a.value=[],t.photo=void 0,i.info("照片已标记为删除。保存后生效。")},F=async()=>{if(r.value)try{await u.updateItem(r.value.id,{remarks:t.remarks,currentDestination:t.currentDestination,photo:t.photo,deletePhoto:p.value}),i.success("物品信息已更新"),k.back()}catch{i.error("更新失败")}};return(l,e)=>{const c=n("a-page-header"),h=n("a-input"),_=n("a-form-item"),S=n("a-textarea"),L=n("a-upload"),N=n("a-image"),I=n("a-button"),O=n("a-empty"),V=n("a-form"),$=n("a-card"),j=n("a-skeleton");return d(),b("div",null,[o(c,{title:`编辑: ${r.value?.shortId}`,onBack:e[0]||(e[0]=()=>f(k).back())},null,8,["title"]),x("div",K,[!f(u).loading&&r.value?(d(),C($,{key:0},{default:s(()=>[o(V,{model:t,onFinish:F,layout:"vertical"},{default:s(()=>[o(_,{label:"去向 (可选)"},{default:s(()=>[o(h,{value:t.currentDestination,"onUpdate:value":e[1]||(e[1]=m=>t.currentDestination=m)},null,8,["value"])]),_:1}),o(_,{label:"备注"},{default:s(()=>[o(S,{value:t.remarks,"onUpdate:value":e[2]||(e[2]=m=>t.remarks=m),rows:4},null,8,["value"])]),_:1}),o(_,{label:"更换照片"},{default:s(()=>[o(L,{"file-list":a.value,"onUpdate:fileList":e[3]||(e[3]=m=>a.value=m),"before-upload":()=>!1,onChange:w,"list-type":"picture-card","max-count":1,accept:"image/*"},{default:s(()=>[!a.value||a.value.length<1?(d(),b("div",Q,[o(f(T)),e[4]||(e[4]=x("div",{style:{"margin-top":"8px"}},"上传",-1))])):D("",!0)]),_:1},8,["file-list"]),y.value&&!p.value?(d(),b("div",X,[e[6]||(e[6]=x("p",null,"当前照片:",-1)),o(N,{width:100,src:y.value},null,8,["src"]),o(I,{type:"link",danger:"",onClick:P},{default:s(()=>e[5]||(e[5]=[U("删除照片",-1)])),_:1,__:[5]})])):D("",!0),!y.value&&!a.value?.length?(d(),C(O,{key:1,description:"暂无照片"})):D("",!0)]),_:1}),o(_,null,{default:s(()=>[o(I,{type:"primary",block:"","html-type":"submit",loading:f(u).loading||g.value},{default:s(()=>e[7]||(e[7]=[U(" 保存更改 ",-1)])),_:1,__:[7]},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})):(d(),C(j,{key:1,active:""}))])])}}}),ne=J(Y,[["__scopeId","data-v-06023bad"]]);export{ne as default};
