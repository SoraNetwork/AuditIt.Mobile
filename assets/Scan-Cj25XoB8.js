import{d as ee,r as p,x as te,o as ae,N as ne,a as f,e as a,m as S,f as s,k as d,w as n,L as oe,M as se,b as C,p as M,l as u,F as le,E as re,G as D,i as z,j as r}from"./index-CPmBGEV4.js";import{a as O}from"./html5-qrcode-scanner-DnqJURBj.js";import{u as ue}from"./itemStore-DSeMWRNL.js";import{_ as ie}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./v4-BKrj-4V8.js";const de={class:"page-container"},ce={key:0},ve={key:0,class:"controls"},_e={key:1},pe={key:2,class:"feedback-container"},fe={key:3,class:"feedback-container"},me={key:4,class:"item-details"},ge={class:"action-buttons"},ke=ee({__name:"Scan",setup(ye){const _=ue();let k=null;const y=p("scan"),L=p(""),m=p(!1),o=p(null),c=p(null),B=p(null),h=p([]),i=p(null),U=async()=>{if(B.value&&(k||(k=new O(B.value.id,{verbose:!1})),h.value.length===0))try{const t=await O.getCameras();if(t&&t.length){h.value=t;let e=t.find(v=>v.label.toLowerCase().includes("back"))||t.find(v=>v.label.toLowerCase().includes("后置"))||t.find(v=>v.label.toLowerCase().includes("rear"))||t[0];i.value=e.id}else c.value="未找到摄像头设备。"}catch{c.value="获取摄像头列表失败，请检查权限。"}},I=t=>{if(!k)return;N();const e={fps:10,qrbox:{width:250,height:250}},v=async w=>{await b(),await $(w)};k.start(t,e,v,void 0).then(()=>{m.value=!0}).catch(w=>{c.value="无法启动摄像头。"})},b=async()=>{if(k&&m.value)try{await k.stop()}catch(t){console.error("Error stopping scanner:",t)}finally{m.value=!1}},V=async()=>{m.value?await b():i.value?I(i.value):c.value="没有可用的摄像头。"},F=async t=>{await b(),i.value=t,I(t)},Q=t=>{t&&$(t)},$=async t=>{await _.fetchItems({shortId:t}),_.items.length>0?o.value=_.items[0]:c.value=`未找到ID为 "${t}" 的物品。`},x=async t=>{if(o.value)try{await _.updateItemStatus(o.value.id,t),z.success(`操作成功: ${t}`),await $(o.value.shortId)}catch{z.error("操作失败")}},N=()=>{o.value=null,c.value=null,L.value="",_.items=[]};te(y,async t=>{t==="scan"?(await U(),i.value&&I(i.value)):await b()}),ae(async()=>{await U(),y.value==="scan"&&i.value&&I(i.value)}),ne(()=>{b()});const R=t=>{switch(t){case"InStock":return"success";case"LoanedOut":return"warning";case"Disposed":return"error";default:return"default"}},T=t=>{switch(t){case"InStock":return"在库";case"LoanedOut":return"已借出";case"Disposed":return"已处置";default:return"未知"}};return(t,e)=>{const v=s("a-page-header"),w=s("a-radio-button"),j=s("a-radio-group"),q=s("a-select-option"),A=s("a-select"),g=s("a-button"),G=s("a-input-search"),H=s("a-form-item"),J=s("a-form"),K=s("a-spin"),P=s("a-alert"),E=s("a-descriptions-item"),W=s("a-badge"),X=s("a-descriptions"),Y=s("a-divider"),Z=s("a-card");return r(),f("div",null,[a(v,{title:"物品操作"}),S("div",de,[a(j,{value:y.value,"onUpdate:value":e[0]||(e[0]=l=>y.value=l),"button-style":"solid",style:{"margin-bottom":"16px",width:"100%"}},{default:n(()=>[a(w,{value:"scan",style:{width:"50%","text-align":"center"}},{default:n(()=>e[7]||(e[7]=[u("扫码输入",-1)])),_:1,__:[7]}),a(w,{value:"manual",style:{width:"50%","text-align":"center"}},{default:n(()=>e[8]||(e[8]=[u("手动输入",-1)])),_:1,__:[8]})]),_:1},8,["value"]),y.value==="scan"?(r(),f("div",ce,[oe(S("div",null,[S("div",{id:"reader",ref_key:"readerRef",ref:B},null,512),h.value.length>1&&m.value?(r(),C(A,{key:0,value:i.value,"onUpdate:value":e[1]||(e[1]=l=>i.value=l),placeholder:"选择摄像头",style:{"margin-top":"8px",width:"100%"},onChange:F},{default:n(()=>[(r(!0),f(le,null,re(h.value,l=>(r(),C(q,{key:l.id,value:l.id},{default:n(()=>[u(D(l.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])):d("",!0)],512),[[se,!o.value&&!c.value]]),o.value?d("",!0):(r(),f("div",ve,[a(g,{onClick:V,danger:m.value,block:"",size:"large"},{default:n(()=>[u(D(m.value?"停止扫描":"开始扫描"),1)]),_:1},8,["danger"])]))])):d("",!0),y.value==="manual"&&!o.value?(r(),f("div",_e,[a(J,null,{default:n(()=>[a(H,{label:"通过物品ID查找"},{default:n(()=>[a(G,{value:L.value,"onUpdate:value":e[2]||(e[2]=l=>L.value=l),placeholder:"输入物品短ID","enter-button":"查找",onSearch:Q},null,8,["value"])]),_:1})]),_:1})])):d("",!0),M(_).loading?(r(),f("div",pe,[a(K,{size:"large",tip:"正在获取物品信息..."})])):d("",!0),c.value&&!M(_).loading?(r(),f("div",fe,[a(P,{message:"错误",description:c.value,type:"error","show-icon":""},{action:n(()=>[a(g,{size:"small",type:"primary",onClick:N},{default:n(()=>e[9]||(e[9]=[u("重试",-1)])),_:1,__:[9]})]),_:1},8,["description"])])):d("",!0),o.value&&!M(_).loading?(r(),f("div",me,[a(Z,{title:o.value.itemDefinition?.name||"未知物品"},{default:n(()=>[a(X,{bordered:"",column:1},{default:n(()=>[a(E,{label:"短ID"},{default:n(()=>[u(D(o.value.shortId),1)]),_:1}),a(E,{label:"状态"},{default:n(()=>[a(W,{status:R(o.value.status),text:T(o.value.status)},null,8,["status","text"])]),_:1}),a(E,{label:"仓库"},{default:n(()=>[u(D(o.value.warehouse?.name),1)]),_:1})]),_:1}),S("div",ge,[e[15]||(e[15]=S("h3",null,"待操作列表",-1)),o.value.status==="InStock"?(r(),C(g,{key:0,onClick:e[3]||(e[3]=l=>x("outbound")),block:""},{default:n(()=>e[10]||(e[10]=[u("借出",-1)])),_:1,__:[10]})):d("",!0),o.value.status==="LoanedOut"?(r(),C(g,{key:1,onClick:e[4]||(e[4]=l=>x("return")),block:""},{default:n(()=>e[11]||(e[11]=[u("归还",-1)])),_:1,__:[11]})):d("",!0),a(g,{onClick:e[5]||(e[5]=l=>x("check")),block:""},{default:n(()=>e[12]||(e[12]=[u("盘点",-1)])),_:1,__:[12]}),o.value.status!=="Disposed"?(r(),C(g,{key:2,onClick:e[6]||(e[6]=l=>x("dispose")),danger:"",block:""},{default:n(()=>e[13]||(e[13]=[u("处置",-1)])),_:1,__:[13]})):d("",!0),a(Y),a(g,{onClick:N,block:""},{default:n(()=>e[14]||(e[14]=[u("查找下一个",-1)])),_:1,__:[14]})])]),_:1},8,["title"])])):d("",!0)])])}}}),Ie=ie(ke,[["__scopeId","data-v-24f8572e"]]);export{Ie as default};
