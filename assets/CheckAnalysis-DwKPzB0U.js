import{u as W}from"./warehouseStore-BrUEpWT3.js";import{u as E}from"./itemStore-BTpaZa-j.js";import{u as F}from"./auditLogStore-jgu213j5.js";import{d as T,C as q,W as A,r as c,o as z,w as G,b as L,f as e,p as $,g as s,h as a,F as H,E as J,q as K,n as i,G as _,k as m,l as y,e as P}from"./index-BGnRgE4q.js";import{_ as Q}from"./_plugin-vue_export-helper-DlAUqK2U.js";const X={class:"page-container"},Y=T({__name:"CheckAnalysis",setup(Z){const b=W(),g=E(),S=F(),l=q({warehouseId:void 0,dateRange:[A().subtract(1,"day"),A()]}),u=c(!1),h=c(!1),p=c([]),f=c([]),d=c({});z(()=>{b.fetchWarehouses()}),G(()=>l.warehouseId,()=>{p.value=[],f.value=[],d.value={}});const C=async()=>{if(!l.warehouseId){m.error("请先选择一个仓库");return}u.value=!0,p.value=[],f.value=[],d.value={};try{await g.fetchItems({warehouseId:l.warehouseId,status:"InStock"});const r=g.items;await S.fetchLogs();const t=l.dateRange[0].startOf("day").toDate(),k=l.dateRange[1].endOf("day").toDate(),v=new Set(S.logs.filter(n=>n.action==="Check"&&n.warehouseId===l.warehouseId&&new Date(n.timestamp)>=t&&new Date(n.timestamp)<=k).map(n=>n.itemId));p.value=r.filter(n=>v.has(n.id)),f.value=r.filter(n=>!v.has(n.id))}catch(r){m.error("分析失败: "+(r.message||r))}finally{u.value=!1}},M=async()=>{const r=Object.entries(d.value).filter(([,t])=>t).map(([t])=>t);if(r.length===0){m.warn("请至少选择一个物品");return}h.value=!0;try{await g.updateStatusBatch(r,"SuspectedMissing"),m.success("成功标记为疑似丢失"),await C()}catch(t){m.error("标记失败: "+(t.message||t))}finally{h.value=!1}};return(r,t)=>{const k=s("a-page-header"),v=s("a-select-option"),n=s("a-select"),I=s("a-form-item"),O=s("a-range-picker"),D=s("a-button"),U=s("a-form"),w=s("a-card"),j=s("a-checkbox"),x=s("a-list-item"),B=s("a-list"),R=s("a-col"),N=s("a-row");return y(),L("div",null,[e(k,{title:"盘点分析","sub-title":"查看盘点差异并处理",onBack:t[0]||(t[0]=()=>r.$router.back())}),$("div",X,[e(w,null,{default:a(()=>[e(U,{model:l,layout:"vertical"},{default:a(()=>[e(I,{label:"选择仓库"},{default:a(()=>[e(n,{value:l.warehouseId,"onUpdate:value":t[1]||(t[1]=o=>l.warehouseId=o),placeholder:"请选择仓库","allow-clear":""},{default:a(()=>[(y(!0),L(H,null,J(K(b).warehouses,o=>(y(),P(v,{key:o.id,value:o.id},{default:a(()=>[i(_(o.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),e(I,{label:"盘点日期范围"},{default:a(()=>[e(O,{value:l.dateRange,"onUpdate:value":t[2]||(t[2]=o=>l.dateRange=o),style:{width:"100%"}},null,8,["value"])]),_:1}),e(I,null,{default:a(()=>[e(D,{type:"primary",onClick:C,loading:u.value,block:""},{default:a(()=>t[3]||(t[3]=[i("开始分析",-1)])),_:1,__:[3]},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),e(N,{gutter:[16,16],style:{"margin-top":"16px"}},{default:a(()=>[e(R,{span:24},{default:a(()=>[e(w,{title:"未盘点物品 (疑似丢失)"},{extra:a(()=>[e(D,{type:"primary",danger:"",size:"small",disabled:Object.values(d.value).every(o=>!o),onClick:M,loading:h.value},{default:a(()=>t[4]||(t[4]=[i(" 标记为丢失 ",-1)])),_:1,__:[4]},8,["disabled","loading"])]),default:a(()=>[e(B,{"data-source":f.value,loading:u.value,bordered:!0},{renderItem:a(({item:o})=>[e(x,null,{default:a(()=>[e(j,{value:o.id,checked:d.value[o.id],"onUpdate:checked":V=>d.value[o.id]=V},{default:a(()=>[i(_(o.itemDefinition?.name)+" ("+_(o.shortId)+") ",1)]),_:2},1032,["value","checked","onUpdate:checked"])]),_:2},1024)]),_:1},8,["data-source","loading"])]),_:1})]),_:1}),e(R,{span:24},{default:a(()=>[e(w,{title:"已盘点物品"},{default:a(()=>[e(B,{"data-source":p.value,loading:u.value,bordered:!0},{renderItem:a(({item:o})=>[e(x,null,{default:a(()=>[i(_(o.itemDefinition?.name)+" ("+_(o.shortId)+")",1)]),_:2},1024)]),_:1},8,["data-source","loading"])]),_:1})]),_:1})]),_:1})])])}}}),ne=Q(Y,[["__scopeId","data-v-9a34046f"]]);export{ne as default};
