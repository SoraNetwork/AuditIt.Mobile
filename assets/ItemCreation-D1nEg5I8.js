import{d as T,C as E,r as m,B as L,o as W,t as G,a as k,e as o,w as l,f as r,J,l as x,E as K,K as z,m as I,p as w,k as X,P as Y,L as Z,i as g,j as N}from"./index-CUAOOoWf.js";import{u as $}from"./itemDefinitionStore-Dkmws-B3.js";import{u as ee}from"./warehouseStore-fS4dEUf7.js";import{H as te,a as ae}from"./html5-qrcode-scanner-DEX2K3uf.js";import{_ as oe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ne={class:"item-creation-container"},le={id:"qr-code-reader"},re={key:0},se=["src"],ie=T({__name:"ItemCreation",setup(ue){const S=$(),b=ee(),t=E({shortId:"",itemDefinitionId:null,warehouseId:null,remarks:"",photo:null}),i=m([]),c=m(!1),u=m(!1);let d=null;const f=m(!1),C=m(""),D=m(""),U=L(()=>t.shortId&&t.itemDefinitionId&&t.warehouseId);W(()=>{S.fetchItemDefinitions(),b.fetchWarehouses()}),G(()=>{v()});const P=({fileList:e})=>{i.value=e,e.length>0&&e[0].originFileObj?t.photo=e[0].originFileObj:t.photo=null},V=async e=>{!e.url&&!e.preview&&(e.preview=await B(e.originFileObj)),C.value=e.url||e.preview,f.value=!0,D.value=e.name||e.url.substring(e.url.lastIndexOf("/")+1)},B=e=>new Promise((a,_)=>{const s=new FileReader;s.readAsDataURL(e),s.onload=()=>a(s.result),s.onerror=h=>_(h)}),F=()=>{f.value=!1},O=()=>{t.shortId="",t.itemDefinitionId=null,t.warehouseId=null,t.remarks="",t.photo=null,i.value=[]},j=async()=>{c.value=!0;const e=new FormData;e.append("shortId",t.shortId),e.append("itemDefinitionId",String(t.itemDefinitionId)),e.append("warehouseId",String(t.warehouseId)),t.remarks&&e.append("remarks",t.remarks),t.photo&&e.append("photo",t.photo);try{await Z.post("/items/create",e,{headers:{"Content-Type":"multipart/form-data"}}),g.success("物品已成功保存!"),O()}catch(a){g.error("保存失败，请重试。"),console.error(a)}finally{c.value=!1}},q=()=>{d||(d=new ae("qr-code-reader")),u.value=!0,d.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250}},(e,a)=>{t.shortId=e,v()},e=>{}).catch(e=>{g.error("无法启动扫描仪，请检查摄像头权限。"),u.value=!1})},v=()=>{d&&d.getState()===te.SCANNING&&d.stop(),u.value=!1},A=()=>{u.value?v():q()};return(e,a)=>{const _=r("a-input"),s=r("a-button"),h=r("a-input-group"),p=r("a-form-item"),y=r("a-select"),H=r("a-textarea"),M=r("a-upload"),Q=r("a-form"),R=r("a-modal");return N(),k("div",ne,[o(Q,{model:t,layout:"vertical"},{default:l(()=>[o(p,{label:"外部条码 (ShortId)"},{default:l(()=>[o(h,{compact:""},{default:l(()=>[o(_,{value:t.shortId,"onUpdate:value":a[0]||(a[0]=n=>t.shortId=n),placeholder:"扫描或输入外部条码",style:{width:"calc(100% - 90px)"}},null,8,["value"]),o(s,{type:"primary",onClick:A},{default:l(()=>[x(K(u.value?"关闭扫描":"扫码"),1)]),_:1})]),_:1})]),_:1}),J(I("div",le,null,512),[[z,u.value]]),o(p,{label:"物品定义",name:"itemDefinitionId"},{default:l(()=>[o(y,{value:t.itemDefinitionId,"onUpdate:value":a[1]||(a[1]=n=>t.itemDefinitionId=n),"show-search":"",placeholder:"搜索物品定义",options:w(S).itemDefinitions.map(n=>({value:n.id,label:n.name}))},null,8,["value","options"])]),_:1}),o(p,{label:"存放仓库",name:"warehouseId"},{default:l(()=>[o(y,{value:t.warehouseId,"onUpdate:value":a[2]||(a[2]=n=>t.warehouseId=n),placeholder:"选择仓库",options:w(b).warehouses.map(n=>({value:n.id,label:n.name}))},null,8,["value","options"])]),_:1}),o(p,{label:"备注"},{default:l(()=>[o(H,{value:t.remarks,"onUpdate:value":a[3]||(a[3]=n=>t.remarks=n)},null,8,["value"])]),_:1}),o(p,{label:"照片"},{default:l(()=>[o(M,{"file-list":i.value,"onUpdate:fileList":a[4]||(a[4]=n=>i.value=n),"list-type":"picture-card","before-upload":()=>!1,onChange:P,onPreview:V},{default:l(()=>[!i.value||i.value.length<1?(N(),k("div",re,[o(w(Y)),a[5]||(a[5]=I("div",{style:{"margin-top":"8px"}},"上传",-1))])):X("",!0)]),_:1},8,["file-list"])]),_:1}),o(p,null,{default:l(()=>[o(s,{type:"primary",onClick:j,loading:c.value,disabled:!U.value,block:""},{default:l(()=>a[6]||(a[6]=[x(" 保存物品 ",-1)])),_:1,__:[6]},8,["loading","disabled"])]),_:1})]),_:1},8,["model"]),o(R,{open:f.value,title:D.value,footer:null,onCancel:F},{default:l(()=>[I("img",{alt:"example",style:{width:"100%"},src:C.value},null,8,se)]),_:1},8,["open","title"])])}}}),ve=oe(ie,[["__scopeId","data-v-823de92c"]]);export{ve as default};
