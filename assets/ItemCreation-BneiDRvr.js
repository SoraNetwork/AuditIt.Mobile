import{d as ne,C as le,r as i,B as re,o as se,t as ie,a as x,e as n,p as I,g as ue,f as r,w as l,J as de,l as g,E as L,K as pe,m as b,b as P,k as R,F as me,D as ce,P as fe,L as ve,i as v,j as _}from"./index-Br5nOBxL.js";import{u as _e}from"./itemDefinitionStore-D1TVw8B0.js";import{u as he}from"./warehouseStore-B0uKJjpw.js";import{H as we,a as O}from"./html5-qrcode-scanner-C6iGJDa3.js";import Ie from"./ItemDefinitionForm-BuPo3oYN.js";import{_ as ge}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./categoryStore-jytu6p5S.js";const be={class:"item-creation-container"},Ce={key:0},ye=["src"],Se=ne({__name:"ItemCreation",setup(De){const j=ue(),F=_e(),N=he(),a=le({shortId:"",itemDefinitionId:null,warehouseId:null,remarks:"",photo:null}),d=i([]),C=i(!1),u=i(!1);let p=null;const y=i([]),S=i(null),D=i(!1),B=i(""),U=i(""),h=i(!1),A=i(null),q=re(()=>a.shortId&&a.itemDefinitionId&&a.warehouseId);se(()=>{F.fetchItemDefinitions(),N.fetchWarehouses()}),ie(()=>{w()});const E=({fileList:e})=>{d.value=e,e.length>0&&e[0].originFileObj?a.photo=e[0].originFileObj:a.photo=null},H=async e=>{!e.url&&!e.preview&&(e.preview=await Q(e.originFileObj)),B.value=e.url||e.preview,D.value=!0,U.value=e.name||e.url.substring(e.url.lastIndexOf("/")+1)},Q=e=>new Promise((t,s)=>{const m=new FileReader;m.readAsDataURL(e),m.onload=()=>t(m.result),m.onerror=f=>s(f)}),T=()=>{D.value=!1},$=()=>{a.shortId="",a.itemDefinitionId=null,a.warehouseId=null,a.remarks="",a.photo=null,d.value=[]},M=async()=>{C.value=!0;const e=new FormData;e.append("shortId",a.shortId),e.append("itemDefinitionId",String(a.itemDefinitionId)),e.append("warehouseId",String(a.warehouseId)),a.remarks&&e.append("remarks",a.remarks),a.photo&&e.append("photo",a.photo);try{await ve.post("/items/create",e,{headers:{"Content-Type":"multipart/form-data"}}),v.success("物品已成功入库!"),$()}catch(t){v.error("保存失败，请检查条码是否已存在。"),console.error(t)}finally{C.value=!1}},W=e=>{h.value=!1,a.itemDefinitionId=e.id},V=e=>{p||(p=new O("qr-code-reader",{verbose:!1,experimentalFeatures:{useBarCodeDetectorIfSupported:!0}})),p.start(e,{fps:10,qrbox:{width:250,height:250}},(t,s)=>{a.shortId=t,w()},t=>{}).catch(t=>{console.error("Scanner start error:",t),v.error("无法启动扫描仪。"),u.value=!1})},w=async()=>{try{p&&p.getState()===we.SCANNING&&await p.stop()}catch(e){console.error("Error stopping scanner:",e)}finally{u.value=!1}},z=async()=>{u.value=!0;try{const e=await O.getCameras();if(e&&e.length){y.value=e;let t=e.find(s=>s.label.toLowerCase().includes("back"))||e.find(s=>s.label.toLowerCase().includes("rear"))||e.find(s=>s.label.toLowerCase().includes("environment"))||e[0];S.value=t.id,V(t.id)}else v.error("未找到摄像头设备。"),u.value=!1}catch{v.error("获取摄像头列表失败，请检查权限。"),u.value=!1}},G=async e=>{await w(),u.value=!0,V(e)},J=async()=>{u.value?await w():await z()};return(e,t)=>{const s=r("a-page-header"),m=r("a-input"),f=r("a-button"),K=r("a-input-group"),c=r("a-form-item"),X=r("a-select-option"),k=r("a-select"),Y=r("a-space-compact"),Z=r("a-textarea"),ee=r("a-upload"),te=r("a-form"),ae=r("a-modal"),oe=r("a-drawer");return _(),x("div",be,[n(s,{title:"快速入库","sub-title":"扫描或输入已有条码",onBack:t[0]||(t[0]=o=>I(j).back())}),n(te,{model:a,layout:"vertical",class:"form-container"},{default:l(()=>[n(c,{label:"外部条码 (ShortId)",name:"shortId"},{default:l(()=>[n(K,{compact:""},{default:l(()=>[n(m,{value:a.shortId,"onUpdate:value":t[1]||(t[1]=o=>a.shortId=o),placeholder:"扫描或输入外部条码",style:{width:"calc(100% - 90px)"}},null,8,["value"]),n(f,{type:"primary",onClick:J},{default:l(()=>[g(L(u.value?"关闭扫描":"扫码"),1)]),_:1})]),_:1})]),_:1}),de(b("div",null,[t[9]||(t[9]=b("div",{id:"qr-code-reader"},null,-1)),y.value.length>1?(_(),P(k,{key:0,value:S.value,"onUpdate:value":t[2]||(t[2]=o=>S.value=o),placeholder:"选择摄像头",style:{"margin-top":"8px",width:"100%"},onChange:G},{default:l(()=>[(_(!0),x(me,null,ce(y.value,o=>(_(),P(X,{key:o.id,value:o.id},{default:l(()=>[g(L(o.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])):R("",!0)],512),[[pe,u.value]]),n(c,{label:"物品定义",name:"itemDefinitionId"},{default:l(()=>[n(Y,{style:{width:"100%"}},{default:l(()=>[n(k,{value:a.itemDefinitionId,"onUpdate:value":t[3]||(t[3]=o=>a.itemDefinitionId=o),"show-search":"",placeholder:"搜索或选择物品定义",options:I(F).itemDefinitions.map(o=>({value:o.id,label:o.name})),style:{width:"calc(100% - 60px)"}},null,8,["value","options"]),n(f,{onClick:t[4]||(t[4]=o=>h.value=!0)},{default:l(()=>t[10]||(t[10]=[g("新建",-1)])),_:1,__:[10]})]),_:1})]),_:1}),n(c,{label:"存放仓库",name:"warehouseId"},{default:l(()=>[n(k,{value:a.warehouseId,"onUpdate:value":t[5]||(t[5]=o=>a.warehouseId=o),placeholder:"选择仓库",options:I(N).warehouses.map(o=>({value:o.id,label:o.name}))},null,8,["value","options"])]),_:1}),n(c,{label:"备注"},{default:l(()=>[n(Z,{value:a.remarks,"onUpdate:value":t[6]||(t[6]=o=>a.remarks=o)},null,8,["value"])]),_:1}),n(c,{label:"照片"},{default:l(()=>[n(ee,{"file-list":d.value,"onUpdate:fileList":t[7]||(t[7]=o=>d.value=o),"list-type":"picture-card","before-upload":()=>!1,onChange:E,onPreview:H},{default:l(()=>[!d.value||d.value.length<1?(_(),x("div",Ce,[n(I(fe)),t[11]||(t[11]=b("div",{style:{"margin-top":"8px"}},"上传",-1))])):R("",!0)]),_:1},8,["file-list"])]),_:1}),n(c,null,{default:l(()=>[n(f,{type:"primary",onClick:M,loading:C.value,disabled:!q.value,block:"",size:"large"},{default:l(()=>t[12]||(t[12]=[g(" 确认入库 ",-1)])),_:1,__:[12]},8,["loading","disabled"])]),_:1})]),_:1},8,["model"]),n(ae,{open:D.value,title:U.value,footer:null,onCancel:T},{default:l(()=>[b("img",{alt:"example",style:{width:"100%"},src:B.value},null,8,ye)]),_:1},8,["open","title"]),n(oe,{title:"新建物品定义",width:"90%",open:h.value,onClose:t[8]||(t[8]=o=>h.value=!1)},{default:l(()=>[n(Ie,{ref_key:"newItemDefFormRef",ref:A,onSubmitted:W},null,512)]),_:1},8,["open"])])}}}),Le=ge(Se,[["__scopeId","data-v-d1b98b6c"]]);export{Le as default};
