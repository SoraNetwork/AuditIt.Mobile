import{d as ne,r as _,w as se,o as oe,N as le,b as m,f as a,p as C,g as o,e as w,m as d,h as n,L as ue,M as re,q as E,n as c,F as ie,E as ce,G as L,O as de,t as z,k as Q,Q as ve,l as r}from"./index-BqQ9Dcin.js";import{a as q}from"./html5-qrcode-scanner-BO_pxmyn.js";import{u as _e}from"./itemStore-CIYP7r49.js";import{_ as pe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const fe={class:"page-container"},me={key:1},ge={key:0,class:"controls"},ke={key:2},ye={key:3,class:"feedback-container"},be={key:4,class:"feedback-container"},we={key:5,class:"item-details"},he={class:"action-buttons"},Se=ne({__name:"Scan",setup(Ce){const p=_e();let b=null;const g=_("scan"),M=_(""),k=_(!1),s=_(null),v=_(null),$=_(null),B=_(!1),I=_([]),i=_(null),T=async()=>{if($.value&&(b||(b=new q($.value.id,{verbose:!1})),I.value.length===0))try{const t=await q.getCameras();if(t&&t.length){I.value=t;let e=t.find(l=>l.label.toLowerCase().includes("back"))||t.find(l=>l.label.toLowerCase().includes("后置"))||t.find(l=>l.label.toLowerCase().includes("rear"))||t[0];i.value=e.id}else v.value="未找到摄像头设备。"}catch{v.value="获取摄像头列表失败，请检查权限。"}},h=t=>{if(!b)return;D();const e={fps:10,qrbox:{width:250,height:250}},l=async f=>{await S(),await N(f)};b.start(t,e,l,void 0).then(()=>{k.value=!0}).catch(f=>{v.value="无法启动摄像头。"})},S=async()=>{if(b&&k.value)try{await b.stop()}catch(t){console.error("Error stopping scanner:",t)}finally{k.value=!1}},A=async()=>{k.value?await S():i.value?h(i.value):v.value="没有可用的摄像头。"},F=async t=>{await S(),i.value=t,h(t)},R=t=>{t&&N(t)},N=async t=>{await p.fetchItems({shortId:t}),p.items.length>0?s.value=p.items[0]:v.value=`未找到ID为 "${t}" 的物品。`},x=async t=>{if(!s.value)return;const e=async l=>{if(s.value)try{await p.updateItemStatus(s.value.id,t,l),Q.success(`操作成功: ${t}`),t==="check"&&B.value?(D(),g.value==="scan"&&i.value&&h(i.value)):await N(s.value.shortId)}catch{Q.error("操作失败")}};if(t==="outbound"||t==="dispose"){let l;const f=t==="outbound"?"借出":"处置";de.confirm({title:`确认${f}`,content:z("div",[z("p","请输入目的地或原因："),z(ve,{placeholder:"例如：借给张三，或处置原因",onChange:O=>{l=O.target.value}})]),onOk:()=>{if(!l)return Q.error("目的地/原因不能为空"),Promise.reject();e(l)}})}else e()},D=()=>{s.value=null,v.value=null,M.value="",p.items=[]};se(g,async t=>{t==="scan"?(await T(),i.value&&h(i.value)):await S()}),oe(async()=>{await T(),g.value==="scan"&&i.value&&h(i.value)}),le(()=>{S()});const j=t=>{switch(t){case"InStock":return"success";case"LoanedOut":return"warning";case"Disposed":return"error";case"SuspectedMissing":return"purple";default:return"default"}},G=t=>{switch(t){case"InStock":return"在库";case"LoanedOut":return"已借出";case"Disposed":return"已处置";case"SuspectedMissing":return"疑似丢失";default:return"未知"}};return(t,e)=>{const l=o("a-page-header"),f=o("a-radio-button"),O=o("a-radio-group"),H=o("a-switch"),V=o("a-form-item"),P=o("a-select-option"),J=o("a-select"),y=o("a-button"),K=o("a-input-search"),W=o("a-form"),X=o("a-spin"),Y=o("a-alert"),U=o("a-descriptions-item"),Z=o("a-badge"),ee=o("a-descriptions"),te=o("a-divider"),ae=o("a-card");return r(),m("div",null,[a(l,{title:"物品操作"}),C("div",fe,[a(O,{value:g.value,"onUpdate:value":e[0]||(e[0]=u=>g.value=u),"button-style":"solid",style:{"margin-bottom":"16px",width:"100%"}},{default:n(()=>[a(f,{value:"scan",style:{width:"50%","text-align":"center"}},{default:n(()=>e[8]||(e[8]=[c("扫码输入",-1)])),_:1,__:[8]}),a(f,{value:"manual",style:{width:"50%","text-align":"center"}},{default:n(()=>e[9]||(e[9]=[c("手动输入",-1)])),_:1,__:[9]})]),_:1},8,["value"]),s.value?.status!=="Disposed"?(r(),w(V,{key:0,label:"连续盘点模式"},{default:n(()=>[a(H,{checked:B.value,"onUpdate:checked":e[1]||(e[1]=u=>B.value=u)},null,8,["checked"])]),_:1})):d("",!0),g.value==="scan"?(r(),m("div",me,[ue(C("div",null,[C("div",{id:"reader",ref_key:"readerRef",ref:$},null,512),I.value.length>1&&k.value?(r(),w(J,{key:0,value:i.value,"onUpdate:value":e[2]||(e[2]=u=>i.value=u),placeholder:"选择摄像头",style:{"margin-top":"8px",width:"100%"},onChange:F},{default:n(()=>[(r(!0),m(ie,null,ce(I.value,u=>(r(),w(P,{key:u.id,value:u.id},{default:n(()=>[c(L(u.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])):d("",!0)],512),[[re,!s.value&&!v.value]]),s.value?d("",!0):(r(),m("div",ge,[a(y,{onClick:A,danger:k.value,block:"",size:"large"},{default:n(()=>[c(L(k.value?"停止扫描":"开始扫描"),1)]),_:1},8,["danger"])]))])):d("",!0),g.value==="manual"&&!s.value?(r(),m("div",ke,[a(W,null,{default:n(()=>[a(V,{label:"通过物品ID查找"},{default:n(()=>[a(K,{value:M.value,"onUpdate:value":e[3]||(e[3]=u=>M.value=u),placeholder:"输入物品短ID","enter-button":"查找",onSearch:R},null,8,["value"])]),_:1})]),_:1})])):d("",!0),E(p).loading?(r(),m("div",ye,[a(X,{size:"large",tip:"正在获取物品信息..."})])):d("",!0),v.value&&!E(p).loading?(r(),m("div",be,[a(Y,{message:"错误",description:v.value,type:"error","show-icon":""},{action:n(()=>[a(y,{size:"small",type:"primary",onClick:D},{default:n(()=>e[10]||(e[10]=[c("重试",-1)])),_:1,__:[10]})]),_:1},8,["description"])])):d("",!0),s.value&&!E(p).loading?(r(),m("div",we,[a(ae,{title:s.value.itemDefinition?.name||"未知物品"},{default:n(()=>[a(ee,{bordered:"",column:1},{default:n(()=>[a(U,{label:"短ID"},{default:n(()=>[c(L(s.value.shortId),1)]),_:1}),a(U,{label:"状态"},{default:n(()=>[a(Z,{status:j(s.value.status),text:G(s.value.status)},null,8,["status","text"])]),_:1}),a(U,{label:"仓库"},{default:n(()=>[c(L(s.value.warehouse?.name),1)]),_:1})]),_:1}),C("div",he,[e[16]||(e[16]=C("h3",null,"待操作列表",-1)),s.value.status==="InStock"?(r(),w(y,{key:0,onClick:e[4]||(e[4]=u=>x("outbound")),block:""},{default:n(()=>e[11]||(e[11]=[c("借出",-1)])),_:1,__:[11]})):d("",!0),s.value.status==="LoanedOut"||s.value.status==="SuspectedMissing"?(r(),w(y,{key:1,onClick:e[5]||(e[5]=u=>x("return")),block:""},{default:n(()=>e[12]||(e[12]=[c("归还",-1)])),_:1,__:[12]})):d("",!0),a(y,{onClick:e[6]||(e[6]=u=>x("check")),block:""},{default:n(()=>e[13]||(e[13]=[c("盘点",-1)])),_:1,__:[13]}),s.value.status!=="Disposed"?(r(),w(y,{key:2,onClick:e[7]||(e[7]=u=>x("dispose")),danger:"",block:""},{default:n(()=>e[14]||(e[14]=[c("处置",-1)])),_:1,__:[14]})):d("",!0),a(te),a(y,{onClick:D,block:""},{default:n(()=>e[15]||(e[15]=[c("查找下一个",-1)])),_:1,__:[15]})])]),_:1},8,["title"])])):d("",!0)])])}}}),Me=pe(Se,[["__scopeId","data-v-40dc37aa"]]);export{Me as default};
